<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Prueba Getnet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://www.pre.globalgetnet.com/digital-checkout/loader.js"></script>
</head>
<body>
  <h1>Checkout Getnet (PRE)</h1>

  <!-- Formulario Cliente -->
  <h3>Datos del Cliente</h3>
  <label>Nombre: <input id="first_name" type="text" value="Facundo" required /></label><br>
  <label>Apellido: <input id="last_name" type="text" value="Rocha" required /></label><br>
  <label>Email: <input id="email" type="email" value="facu@test.com" required /></label><br>
  <label>Tel칠fono: <input id="telefono" type="text" value="1122334455" /></label><br>
  <label>Documento (DNI): <input id="dni" type="text" value="36904411" required /></label><br>

  <br>
  <!-- Monto -->
  <label>Monto (ARS): 
    <input id="amount" type="number" value="1000" min="10" step="1" />
  </label>
  <button id="btn">Pagar</button>

  <hr>

  <!-- Cancelaci칩n -->
  <label>Cancelar pago (payment_id):
    <input id="cancelId" type="text" placeholder="Ingres치 payment_id" style="width:400px;" />
  </label>
  <button id="btnCancel">Cancelar</button>

  <br><br>

  <!-- Refund -->
  <label>Devoluci칩n (payment_id):
    <input id="refundId" type="text" placeholder="Ingres치 payment_id" style="width:400px;" />
  </label>
  <label>Monto (centavos):
    <input id="refundAmount" type="number" placeholder="Ej: 10000 para $100" style="width:200px;" />
  </label>
  <button id="btnRefund">Refund</button>

  <div id="checkout-container" style="margin-top:20px; min-height: 540px;"></div>
  <pre id="debug" style="margin-top:20px; background:#eee; padding:10px;"></pre>

  <script>
    const API_BASE = location.origin;

    async function crearIntent(amount) {
      const orderId = 'ORD-' + Date.now();

      // 游녤 Armar objeto con datos del cliente
      const customer = {
        first_name: document.getElementById('first_name').value,
        last_name: document.getElementById('last_name').value,
        email: document.getElementById('email').value,
        telefono: document.getElementById('telefono').value,
        document_type: 'dni',
        document_number: document.getElementById('dni').value
      };

      const r = await fetch(`${API_BASE}/getnet/public/getnet/intent.php`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ amount: Number(amount), orderId, customer })
      });

      const j = await r.json();
      if (!r.ok) throw new Error(`HTTP ${r.status}: ${JSON.stringify(j)}`);
      return j;
      
    }

    async function getAccessToken() {
      const r = await fetch(`${API_BASE}/getnet/public/getnet/token.php`);
      const j = await r.json();
      if (!r.ok || !j.access_token) throw new Error('Error token');
      return j.access_token;
    }

    // 游녤 Pago
    document.getElementById('btn').addEventListener('click', async () => {
      try {
        const amount = document.getElementById('amount').value || 1000;
        const token = await getAccessToken();
        const intent = await crearIntent(amount);

        document.getElementById("debug").textContent = JSON.stringify(intent, null, 2);

        const paymentIntentId = intent.id || intent.payment_intent_id || intent.paymentId;
        if (paymentIntentId) {
          sessionStorage.setItem("lastPaymentId", paymentIntentId);
        }

        const link = intent.payment_link || intent.redirectUrl || intent.redirect_url || intent.url;
        if (link) {
          setTimeout(() => { window.location.href = link; }, 3000);
          return;
        }

        if (window.GetnetCheckout && typeof window.GetnetCheckout.load === 'function') {
          if (!paymentIntentId) throw new Error('No se encontr칩 paymentIntentId en la respuesta');
          window.GetnetCheckout.load({
            authorization: `Bearer ${token}`,
            paymentIntentId,
            checkoutType: 'iframe',
            containerId: 'checkout-container'
          });
        }
      } catch (e) {
        console.error(e);
        alert('Error: ' + e.message);
      }
    });

    // 游녤 Cancelar
    document.getElementById('btnCancel').addEventListener('click', async () => {
      const pid = document.getElementById('cancelId').value.trim();
      if (!pid) {
        alert("Ingres치 un payment_id para cancelar.");
        return;
      }
      try {
        const r = await fetch(`${API_BASE}/getnet/public/getnet/cancel.php?payment_id=${encodeURIComponent(pid)}`);
        const text = await r.text();
        document.getElementById("debug").textContent = "Cancel response:\n" + text;
      } catch (e) {
        alert("Error cancelando: " + e.message);
      }
    });

    // 游녤 Refund
    document.getElementById('btnRefund').addEventListener('click', async () => {
      const pid = document.getElementById('refundId').value.trim();
      const amount = document.getElementById('refundAmount').value.trim();
      if (!pid || !amount) {
        alert("Ingres치 payment_id y amount para refund.");
        return;
      }
      try {
        const r = await fetch(`${API_BASE}/getnet/public/getnet/refund.php?payment_id=${encodeURIComponent(pid)}&amount=${encodeURIComponent(amount)}`);
        const text = await r.text();
        document.getElementById("debug").textContent = "Refund response:\n" + text;
      } catch (e) {
        alert("Error en refund: " + e.message);
      }
    });
  </script>
</body>
</html>
