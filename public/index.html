<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Prueba Getnet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://www.pre.globalgetnet.com/digital-checkout/loader.js"></script>
</head>
<body>
  <h1>Checkout Getnet (PRE)</h1>

  <label>Monto (ARS): 
    <input id="amount" type="number" value="1000" min="10" step="1" />
  </label>
  <button id="btn">Pagar</button>

  <br><br>
  <label>Cancelar pago (payment_id):
    <input id="cancelId" type="text" placeholder="Ingres치 payment_id" style="width:400px;" />
  </label>
  <button id="btnCancel">Cancelar</button>

  <div id="checkout-container" style="margin-top:20px; min-height: 540px;"></div>
  <pre id="debug" style="margin-top:20px; background:#eee; padding:10px;"></pre>

  <script>
    const API_BASE = location.origin;

    async function crearIntent(amount) {
      const orderId = 'ORD-' + Date.now();
      const r = await fetch(`${API_BASE}/api/getnet/intent.php`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ amount: Number(amount), orderId })
      });
      const text = await r.text();
      if (!r.ok) throw new Error(`HTTP ${r.status}: ${text}`);
      try { return JSON.parse(text); } catch(e) { throw new Error(`JSON inv치lido: ${text}`); }
    }

    async function getAccessToken() {
      const r = await fetch(`${API_BASE}/api/getnet/token.php`);
      const j = await r.json();
      if (!r.ok || !j.access_token) throw new Error('Error token');
      return j.access_token;
    }

    document.getElementById('btn').addEventListener('click', async () => {
      try {
        const amount = document.getElementById('amount').value || 1000;
        console.log("trayendo token");
        const token = await getAccessToken();
        console.log("intento intent");
        const intent = await crearIntent(amount);
        
        // 游댳 Mostrar en consola
        console.log("Respuesta completa de intent:", intent);

        // 游댳 Mostrar en pantalla tambi칠n
        document.getElementById("debug").textContent = JSON.stringify(intent, null, 2);

        const paymentIntentId = intent.id || intent.payment_intent_id || intent.paymentId;
        if (paymentIntentId) {
          sessionStorage.setItem("lastPaymentId", paymentIntentId);
        }

        const link = intent.payment_link || intent.redirectUrl || intent.redirect_url || intent.url;
        if (link) {
          console.log("Redirigiendo en 5 segundos a:", link);
          setTimeout(() => { window.location.href = link; }, 5000);
          return;
        }

        if (window.GetnetCheckout && typeof window.GetnetCheckout.load === 'function') {
          if (!paymentIntentId) throw new Error('No se encontr칩 paymentIntentId en la respuesta');
          window.GetnetCheckout.load({
            authorization: `Bearer ${token}`,
            paymentIntentId,
            checkoutType: 'iframe',
            containerId: 'checkout-container'
          });
          return;
        }

        alert('La respuesta no trae link ni podemos cargar loader. Revis치 la consola.');
      } catch (e) {
        console.error(e);
        alert('Error: ' + e.message);
      }
    });

    // 游댳 Cancelar pago
    document.getElementById('btnCancel').addEventListener('click', async () => {
      const pid = document.getElementById('cancelId').value.trim();
      if (!pid) {
        alert("Ingres치 un payment_id para cancelar.");
        return;
      }
      try {
        const r = await fetch(`${API_BASE}/api/getnet/cancel.php?payment_id=${encodeURIComponent(pid)}`);
        const text = await r.text();
        document.getElementById("debug").textContent = "Cancel response:\n" + text;
      } catch (e) {
        alert("Error cancelando: " + e.message);
      }
    });
  </script>
</body>
</html>
